# MT5連携モジュール

## 概要

このモジュールはMetaTrader 5 (MT5)から出力された経済指標データを監視し、処理するための機能を提供します。ファイル監視ベースの連携方式を採用しており、MT5側で出力されたCSVファイルを検出し、データ処理パイプラインに渡します。

## 主な機能

- CSVディレクトリの監視
- 新しい経済指標データファイルの検出
- 完了フラグファイルの確認
- データの読み込みと前処理
- エラー処理とリカバリーメカニズム

## ファイル構成

- `mt5_integration.py`: MT5連携モジュールのメインコード
- `run_mt5_integration.py`: コマンドライン引数を解析し、MT5連携モジュールを実行するスクリプト
- `run_mt5_integration.bat`: Windows環境での実行用バッチファイル
- `run_mt5_integration.sh`: Unix系環境での実行用シェルスクリプト

## 使用方法

### MT5側の設定

1. `EconomicIndicatorsExporter_Auto.mq5`をMT5のScriptsフォルダにコピーします
2. MT5を起動し、ナビゲーターからスクリプトを選択して実行します
3. 以下のパラメータを設定します:
   - 取得開始日: データ取得の開始日
   - 取得終了日: データ取得の終了日（0を指定すると現在日時）
   - 出力ディレクトリ: CSVファイルの出力先ディレクトリ
   - 自動出力モード: 定期的に自動出力するかどうか
   - 自動出力間隔: 自動出力する間隔（分）

### Python側の設定

1. 必要なライブラリをインストールします:
   ```
   pip install -r requirements.txt
   ```

2. 以下のいずれかの方法でモジュールを実行します:

   **Windows環境:**
   ```
   run_mt5_integration.bat
   ```

   **Unix系環境:**
   ```
   ./run_mt5_integration.sh
   ```

   **直接Pythonで実行:**
   ```
   python run_mt5_integration.py [オプション]
   ```

### コマンドラインオプション

- `--csv-dir`: MT5から出力されるCSVファイルのディレクトリ（デフォルト: "../csv/EconomicIndicators"）
- `--output-dir`: 処理後のデータを保存するディレクトリ（デフォルト: "../csv/MergedData"）
- `--done-suffix`: 完了フラグファイルの接尾辞（デフォルト: ".done"）
- `--retry-interval`: エラー時のリトライ間隔（秒）（デフォルト: 60）
- `--max-retries`: 最大リトライ回数（デフォルト: 5）
- `--log-level`: ログレベル（デフォルト: INFO）

## 動作の流れ

1. MT5側でスクリプトを実行し、経済指標データをCSVファイルに出力します
2. 出力完了時に`.done`拡張子の完了フラグファイルを作成します
3. Python側のファイル監視システムがCSVファイルと完了フラグファイルを検出します
4. 検出したCSVファイルを読み込み、データの前処理を行います
5. 処理済みデータを出力ディレクトリに保存します

## エラー処理

- ファイル読み込みエラーが発生した場合、設定された回数だけリトライします
- リトライ間隔と最大リトライ回数はコマンドラインオプションで設定できます
- すべてのエラーはログファイル（`mt5_integration.log`）に記録されます

## 注意事項

- MT5とPythonアプリは同じマシンまたはネットワーク共有フォルダにアクセスできる環境で実行する必要があります
- VPS環境で使用する場合は、ファイルアクセス権限を適切に設定してください
- 大量のデータを処理する場合は、メモリ使用量に注意してください 